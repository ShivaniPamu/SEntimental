name: SEntimental - CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout repository
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2️⃣ Set up Python
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    # 3️⃣ Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install --upgrade setuptools wheel
        pip install -r requirements.txt
        pip install matplotlib seaborn tabulate imbalanced-learn

    # 4️⃣ List repo files (optional)
    - name: List repo files
      run: ls -R

    # 5️⃣ Train Model
    - name: Train Model
      run: python train.py

    # 6️⃣ Evaluate Model (Metrics, Confusion Matrix, Loss Plots)
    - name: Evaluate Model
      run: python test_model.py

    # 7️⃣ Commit outputs and update README
    - name: Commit outputs and update README
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

        # Start README
        echo "# Latest Model Results" > README.md

        # Append confusion matrix
        [ -f confusion_matrix.md ] && cat confusion_matrix.md >> README.md

        # Append metrics (Accuracy, Precision, Recall, F1)
        [ -f metrics.md ] && cat metrics.md >> README.md

        # Embed loss plot image in README
        [ -f loss_plot.png ] && echo -e "\n## Training/Validation Loss\n![Loss Plot](loss_plot.png)\n" >> README.md

        # Add all files conditionally
        [ -f confusion_matrix.csv ] && git add confusion_matrix.csv
        [ -f predictions.csv ] && git add predictions.csv
        [ -f confusion_matrix.png ] && git add confusion_matrix.png
        [ -f metrics.md ] && git add metrics.md
        [ -f loss_plot.png ] && git add loss_plot.png
        [ -f models/logreg_model.pkl ] && git add models/logreg_model.pkl
        [ -f models/tfidf_vectorizer.pkl ] && git add models/tfidf_vectorizer.pkl
        [ -f models/train_history.pkl ] && git add models/train_history.pkl
        git add README.md

        # Commit changes
        git commit -m "Update README, metrics, plots, and models" || echo "No changes to commit"

        # Push to main
        git push https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git HEAD:main
